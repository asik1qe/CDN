name: CDN CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-test-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate docker-compose.yaml
        shell: powershell
        run: |
          Write-Host "Validating docker-compose.yaml..."
          docker compose config

      - name: Test deploy stack (validation only)
        shell: powershell
        run: |
          Write-Host "Deploying test stack cdnstack-test..."
          docker stack deploy -c docker-stack.yaml cdnstack-test
          Start-Sleep -Seconds 5
          docker stack services cdnstack-test
          Write-Host "Removing test stack..."
          docker stack rm cdnstack-test

      - name: Build images
        shell: powershell
        run: |
          Write-Host "Building Docker images..."
          docker compose build

      - name: Deploy production stack
        shell: powershell
        run: |
          Write-Host "Deploying production stack..."
          docker stack deploy -c docker-stack.yaml cdnstack

      - name: Validate Swarm service replicas
        shell: powershell
        run: |
          Write-Host "Checking replicas..."
          Start-Sleep -Seconds 5
          $services = docker stack services cdnstack --format '{{.Name}} {{.Replicas}}'
          Write-Host $services
          $bad = $services | Select-String " 0\/"
          if ($bad) {
            Write-Error "Some services have missing replicas: $bad"
            exit 1
          }
          Write-Host "All services have correct number of replicas."

      - name: HTTP Smoke Test
        shell: powershell
        run: |
          Write-Host "Running HTTP smoke test..."
          Start-Sleep -Seconds 3
          $response = Invoke-WebRequest -Uri "http://localhost:8082" -UseBasicParsing
          if ($response.StatusCode -ne 200) {
            Write-Error "Unexpected HTTP code: $($response.StatusCode)"
            exit 1
          }
          if (-not $response.Content.Contains("<h1>")) {
            Write-Error "Response does not contain <h1>"
            exit 1
          }
          Write-Host "Smoke test passed."
