name: CDN CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-test-deploy:
    runs-on: self-hosted

    defaults:
      run:
        shell: cmd

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      :: 1. Проверка docker-compose.yaml
      - name: Validate docker-compose.yaml
        run: |
          echo Validating docker-compose.yaml...
          docker compose config

      :: 2. Тестовый деплой для проверки docker-stack.yaml
      - name: Test deploy stack (validation only)
        run: |
          echo Deploying test stack cdnstack-test...
          docker stack deploy -c docker-stack.yaml cdnstack-test
          timeout /t 5 /nobreak >NUL
          echo Test stack services:
          docker stack services cdnstack-test
          echo Removing test stack...
          docker stack rm cdnstack-test

      :: 3. Сборка Docker-образов
      - name: Build images
        run: |
          echo Building Docker images...
          docker compose build

      :: 4. Боевой деплой в Swarm
      - name: Deploy production stack
        run: |
          echo Deploying production stack...
          docker stack deploy -c docker-stack.yaml cdnstack

      :: 5. Проверка, что нет сервисов с 0 реплик
      - name: Validate Swarm service replicas
        run: |
          echo Checking replicas...
          timeout /t 5 /nobreak >NUL
          docker stack services cdnstack --format "{{.Name}} {{.Replicas}}" > services.txt
          echo Current services:
          type services.txt
          find " 0/" services.txt > bad.txt
          if %ERRORLEVEL%==0 (
            echo Some services have 0 running replicas:
            type bad.txt
            exit /b 1
          ) else (
            echo All services have at least 1 running replica.
          )

      :: 6. HTTP Smoke Test через CDN (load-balancer)
      - name: HTTP Smoke Test
        run: |
          echo Running HTTP smoke test...
          timeout /t 5 /nobreak >NUL
          powershell -NoProfile -ExecutionPolicy Bypass -Command ^
            "$resp = Invoke-WebRequest -Uri 'http://localhost:8082' -UseBasicParsing; " ^
            "if ($resp.StatusCode -ne 200 -or -not $resp.Content.Contains('<h1>')) { Write-Error 'Bad response from CDN'; exit 1 }"
          if %ERRORLEVEL% NEQ 0 (
            echo Smoke test failed.
            exit /b 1
          ) else (
            echo Smoke test passed.
          )